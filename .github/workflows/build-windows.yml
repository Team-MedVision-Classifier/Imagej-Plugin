name: build-windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Download standalone Python
        working-directory: cellpose backend
        shell: pwsh
        env:
          PYBS_RELEASE: latest
          PYBS_ASSET_REGEX: '^cpython-3\.10\..*-windows.*-install_only\.tar\.gz$'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "import json, os, re, urllib.request; release=os.environ.get('PYBS_RELEASE','latest'); api=f'https://api.github.com/repos/astral-sh/python-build-standalone/releases/{release}'; token=os.environ.get('GITHUB_TOKEN',''); headers={'Authorization': 'Bearer ' + token, 'User-Agent': 'cellpose-plugin-builder', 'Accept': 'application/vnd.github+json'}; req=urllib.request.Request(api, headers=headers); data=json.load(urllib.request.urlopen(req)); pattern=re.compile(os.environ['PYBS_ASSET_REGEX']); url=name=None;\
          [ (lambda a: (globals().update(url=a.get('browser_download_url'), name=a.get('name')))) (a) for a in data.get('assets', []) if pattern.search(a.get('name','')) and (globals().get('url') is None) ];\
          (url is not None) or (_ for _ in ()).throw(SystemExit('No matching standalone Python asset found.'));\
          print(f'Downloading {name}'); urllib.request.urlretrieve(url, 'pybs.tar.gz')"

          if (Test-Path py_standalone) { Remove-Item -Recurse -Force py_standalone }
          New-Item -ItemType Directory -Path py_standalone | Out-Null
          tar -xzf pybs.tar.gz -C py_standalone

            python -c "from pathlib import Path; import os; root=Path('py_standalone'); candidates=list(root.rglob('python.exe'));\
            next((lambda c: (open(os.environ['GITHUB_ENV'],'a').write(f'PY_STANDALONE={c}\\n'), print(f'PY_STANDALONE={c}')))(c) for c in candidates if c.is_file()), None) or (_ for _ in ()).throw(SystemExit('Standalone python.exe not found after extract.'))"

      - name: Create venvs and install deps
        working-directory: cellpose backend
        shell: pwsh
        run: |
          & "$env:PY_STANDALONE" -m venv venv_v3
          .\venv_v3\Scripts\pip install -r requirements_v3.txt
          & "$env:PY_STANDALONE" -m venv venv_v4
          .\venv_v4\Scripts\pip install -r requirements_v4.txt

      - name: Build plugin
        working-directory: cellpose frontend
        shell: pwsh
        run: mvn -q -DskipTests package

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: cellpose-plugin-windows
          path: cellpose frontend/target/*.jar
